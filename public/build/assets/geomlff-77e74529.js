const d=window.burl,m=$("input[name=_id]").val();var f=[],v="https://tile.openstreetmap.org/{z}/{x}/{y}.png",w=L.tileLayer(v,{minZoom:5}),t=new L.Map("objmap",{center:new L.LatLng(.339951,120.373368),zoom:5,attributionControl:!1,fullscreenControl:!0}),i=L.featureGroup().addTo(t),c={},g=0;L.Control.geocoder().addTo(t);L.control.layers({osm:w.addTo(t),google:L.tileLayer("http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}",{attribution:"google"})},{drawlayer:i},{position:"topright",collapsed:!1}).addTo(t);self.resPolygon={};self.drawControlFull=new L.Control.Draw({edit:{featureGroup:i,poly:{allowIntersection:!1}},draw:{polygon:{allowIntersection:!1,showArea:!0},polyline:!1,rectangle:!1,marker:!1,circle:!1,circlemarker:!1}});self.drawControlEdit=new L.Control.Draw({edit:{featureGroup:i,poly:{allowIntersection:!1}},draw:!1});t.addControl(drawControlFull);t.on(L.Draw.Event.CREATED,function(l){if(self.Polygon||self.Circle)return toastr.error("You can only create 1 location per geofence","Warning"),null;var e=l.layer;if(console.log(e,e._latlng,e._mRadius),e._latlng&&e._mRadius)window.circle=e;else if(e._latlngs&&e._bounds){if(f=e._latlngs[0],f.length<4)return toastr.error("Minimum 4 points required!","Warning"),null;self.Polygon=e,self.Polygon.setStyle({color:"#16FF00",fillColor:"#16FF00",fillOpacity:.1})}else return null;self.drawControlFull.remove(),self.drawControlEdit.addTo(t),i.addLayer(e)});t.on(L.Draw.Event.EDITED,function(l){var e=l.layers;e.eachLayer(function(o){if(o._latlng&&o._mRadius)console.log(o._latlng,o._mRadius);else if(o._latlngs&&o._bounds){if(f=o._latlngs[0],f.length<4)return toastr.error("Minimum 4 points required!","Warning"),self.Polygon.remove(),self.Polygon=null,self.drawControlEdit.remove(),self.drawControlFull.addTo(t),i.clearLayers(),null}else toastr.error("Please make 1 Geofencing!","Error")})});t.on(L.Draw.Event.DELETED,function(l){var e=l.layers;e.eachLayer(function(o){self.Circle=null,self.Polygon=null,f=[],self.drawControlEdit.remove(),self.drawControlFull.addTo(t)})});$("#formGeo").submit(function(l){l.preventDefault();var e=$("input[name=_backurl]").val(),o=new FormData;if(o.append("_token",$("input[name=_token]").val()),o.append("id",$("input[name=_id]").val()),o.append("gate_id",$("#sel_toll_gate").val()),o.append("_isEdit",g),console.log(g),typeof self.Polygon<"u"&&self.Polygon!==null){for(const[n,r]of Object.entries(c))delete c[n];$.each(self.Polygon._latlngs,function(n,r){$.each(r,function(u,p){c[u]={lat:p.lat,lng:p.lng}})}),console.log(JSON.stringify(c));var a=$("select[name=gate_declare]").val();if(a<=0)return toastr.error("Please select declaration!","Warning"),null;o.append("geo_type",parseInt(a)),o.append("polygon_point",JSON.stringify(c))}else return toastr.error("Please make 1 Geofencing!","Warning"),null;$.ajax({type:"POST",url:d+"/geomlff/js/add",data:o,dataType:"json",contentType:!1,cache:!1,processData:!1,beforeSend:function(){$("#formGeo").css("opacity",".5")},success:function(n){$("#formGeo").css("opacity","");var r=n.msg;r.code===200?swal({title:"Success",text:"Continue editing?",type:"success",showCancelButton:!0,confirmButtonClass:"btn-primary",confirmButtonText:"Yes, continue editing!",cancelButtonText:"No, take me back!",closeOnConfirm:!1,closeOnCancel:!1},function(u){u?window.location.href=d+"/geomlff/detail/"+m:window.location.href=e}):(console.log(n),toastr.error(n.msg,"Error"))}})});$("#sel_toll_section").select2();$("#sel_toll_gate").select2();axios.get(d+"/geomlff/gatepoint/section/js").then(l=>{$("#sel_toll_section").select2({data:l.data.sectionName})}).catch(l=>{console.log(l)});var s;$("#sel_toll_section").on("change",function(){s&&t.removeLayer(s),_($("#sel_toll_section").val())});function _(l){axios.get(d+`/geomlff/gatepoint/section/js/${l}`).then(e=>{$("#sel_toll_gate").select2({data:e.data.gatePoint})}).catch(e=>{console.log(e)})}$("#sel_toll_gate").on("change",function(){s&&t.removeLayer(s),y($("#sel_toll_gate").val())});function y(l){axios.get(d+`/geomlff/gatepoint/section/det/js/${l}`).then(e=>{console.log(e);var o=e.data.gatePoint,a="n/a";o.fnpayment_type===1?a="Open":o.fnpayment_type===2&&(a="Close"),s=window._newMarker({lat:o.fflat,lng:o.fflon},{icon:L.icon({iconUrl:window.gateUrl,iconSize:[30,30],iconAnchor:[8,25],popupAnchor:[0,-20]})},null,`<h3 class="h6 text-center d-block text-uppercase font-weight-bold">INFO</h3><span class="bottom-line d-block mx-auto mt-3 mb-4"></span><div class="row my-2 mx-auto"><div class="col text-right border-right border-dark">GATE NAME</div><div class="col-7 pl-4">${o.ftname}</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">SECTION</div><div class="col-7 pl-4">${o.ftsection}</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">PAYMENT TYPE</div><div class="col-7 pl-4">${a}</div></div>`),s.addTo(t);var n=new L.FeatureGroup;n.addLayer(s),n.addTo(t),t.fitBounds(n.getBounds())})}$.get(d+`/geomlff/js/detail/${m}/point`,function(l){var e=l.dataHead;l.dataHead&&y(e.uuid_x_gate_point_id);var o=[];if($.each(l.dataPoint,function(n,r){g=1,o.push([r.fflat,r.fflon])}),l.dataPoint.length!==0){var a=L.polygon(o);self.Polygon=a,i.addLayer(a),t.fitBounds(i.getBounds()),self.drawControlFull.remove(),self.drawControlEdit.addTo(t),g===1&&(_(e.ftsection),$("input[name=sel_toll_gate]").val(e.uuid_x_gate_point_id))}});
