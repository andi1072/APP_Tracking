var t,i,r=new L.featureGroup([]),l,d,s=$("#tblmlff_sec").DataTable({lengthChange:!1,order:[[1,"desc"]],scrollX:!0,columnDefs:[{visible:!1,targets:[0]},{targets:-1,defaultContent:'<button class="btnview btn btn-pure btn-primary icon md-view waves-effect waves-classic">MAP</button>'}]}),f=null;$("#tblmlff_sec tbody").on("click","button.btnview",function(){var a=s.row($(this).parents("tr")).data();f=a[0],$("#modallog").modal("show"),console.log(a[0])});var u=$("input[name=_deviceid]").val();axios.get(`${window.burl}/devtools/mlff/js/history/section?did=${u}`).then(a=>{a.data.data.length<=0||$.each(a.data.data,function(n,e){e.fdexit_time&&(window.dtHumanParse(e.fdexit_time),e.ftexit_location),s.row.add([e.id,window.dtHumanParse(e.fdentry_time),e.ftentry_gate,e.ftentry_point,e.ftentry_section,window.dtHumanParse(e.fdexit_time),e.ftexit_gate,e.ftexit_point,e.ftexit_section,`${parseFloat(e.ffdistence_section).toFixed(2)} km`,`${parseFloat(e.ffavgspeed).toFixed(2)} km/h`]).draw(!0)})}).catch(a=>{console.log(a)});$("#modallog").on("shown.bs.modal",function(){if(!t){t=L.map("trackingmlff_log",{minZoom:5,fullscreenControl:!0,attributionControl:!1}).setView([.33995192349439596,120.3733680354565],5);var a=L.tileLayer(window.mapLayer);a.addTo(t)}$.get(`${window.burl}/devtools/mlff/js/history/section/log?section_history=${f}`,function(n){console.log(n.data.data);var e=n.data.data;n.data.routes&&m(e,n.data.routes)})});$("#modallog").on("hidden.bs.modal",function(){t.removeLayer(i),l&&t.removeLayer(l),d&&t.removeLayer(d),t.removeLayer(r)});function m(a,n){var e={type:"FeatureCollection",name:"line_relay",features:[{type:"Feature",properties:a,geometry:{type:"LineString",coordinates:n}}]};function c(_){r=new L.featureGroup([]);var o=_.properties;return l=window._newMarker({lat:parseFloat(o.ffentry_lat),lng:parseFloat(o.ffentry_lon)},{icon:L.icon({iconUrl:`${window.burl}/assets/images/leaflet/entry.png`,iconSize:[40,40],iconAnchor:[19,34],popupAnchor:[0,-15]})},o.gate_name,null).addTo(t),o.fdexit_time&&(d=window._newMarker({lat:parseFloat(o.ffexit_lat),lng:parseFloat(o.ffexit_lon)},{icon:L.icon({iconUrl:`${window.burl}/assets/images/leaflet/exit.png`,iconSize:[40,40],iconAnchor:[19,34],popupAnchor:[0,-15]})},o.gate_name,null).addTo(t)),{pane:"pane_line_relay",opacity:1,color:"#FF0032",dashArray:"",lineCap:"square",lineJoin:"bevel",weight:1,fillOpacity:0,interactive:!0}}t.createPane("pane_line_relay"),t.getPane("pane_line_relay").style.zIndex=401,t.getPane("pane_line_relay").style["mix-blend-mode"]="normal",i=new L.geoJson(e,{attribution:"",interactive:!0,dataVar:"json_line_relay",layerName:"layer_line_relay",pane:"pane_line_relay",style:c}),r.addLayer(i),t.addLayer(i),t.fitBounds(r.getBounds())}
